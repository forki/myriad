@{
    ViewBag.Title = "Home Page";
}

@{
    var client = new WebClient();
    var json = client.DownloadString("http://localhost:8083/metadata");
    var metadata = Json.Decode(json);

    var dimensionsJson = client.DownloadString("http://localhost:8083/api/1/dimensions/list");
    var dimensions = Json.Decode<List<string>>(dimensionsJson);

    var columnList = new List<string>(dimensions);
    columnList.AddRange( new string[] { "Property", "Value" } );
}

<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title></title>

    <script src="@Href("~/Scripts/jquery-1.10.2.min.js")" type="text/javascript"></script>
    
    <script src="@Href("~/Scripts/jquery-ui-1.11.4/jquery-ui.min.js")" type="text/javascript"></script>
    <link href="@Href("~/Scripts/jquery-ui-1.11.4/jquery-ui.theme.min.css")" type="text/css" rel="stylesheet"/>
    <link href="@Href("~/Scripts/jquery-ui-1.11.4/jquery-ui.css")" type="text/css" rel="stylesheet"/>

    <link href="@Href("~/Content/datatables.min.css")" rel="stylesheet" type="text/css" />
    <script src="@Href("~/Scripts/datatables.min.js")" type="text/javascript"></script>

    <link href="@Href("~/Content/dashboard.css")" rel="stylesheet" type="text/css" />

    <script type="text/javascript">        
        $(function () {
            $('#btnQuery').button({ icons: { primary: "ui-icon-search" } });

            @foreach (var result in metadata)
            {
                @*var addButton = "#btnAdd" + result.Dimension.Name;
                var clearButton = "#btnClear" + result.Dimension.Name;
                @:$('@addButton').button({ icons: { primary: "ui-icon-plusthick" }, text: false });
                @:$('@clearButton').button({ icons: { primary: "ui-icon-closethick" }, text: false });*@

                var selectList = "#list" + result.Dimension.Name;
                @:$('@selectList ul').append(
                @:    $('<li>').append(
                @:      $('<a>').attr('href', '/user/messages').append(
                @:          $('<span>').attr('class', 'tab').append("Message center")
                @:)));

                @:var values = [];
                foreach (var value in result.Values)
                {
                @:values.push('@value');
                }
                @:values.sort();
                @:$('#@result.Dimension.Name').autocomplete({ source: values, minLength: 0 });
            }
        });

        $(document).ready(function () {

            var columns = [];
            @foreach (var column in columnList)
            {
                @:columns.push({ title: '@column', data: '@column' });
            }

            $('#btnQuery').click(
                function () {
                    //var values = {};
                    
                    //$.each($('#queryForm').serializeArray(), function (i, field) {
                    //    if (field.value) {
                    //        values[field.name] = field.value;
                    //    }
                    //});
                    
                    //$.post("http://localhost:8083/query", values,
                    //    function (data) {
                    //        alert(data);
                    //        var localTable = $('#resultsTable').DataTable();
                    //        localTable.data = data;
                    //    }, "jsonp"
                    //);

                    var table = $('#resultsTable').DataTable({
                        columns: columns,
                        "bProcessing": true,
                        "bServerSide": true,
                        "sAjaxSource": "http://localhost:8083/query",
                        "fnServerData": function (sSource, aoData, fnCallback) {                            
                            $.each($('#queryForm').serializeArray(), function (i, field) {
                                if (field.value) {
                                    aoData.push( field );
                                }
                            });

                            $.ajax({
                                "dataType": 'json',
                                "contentType": "application/json; charset=UTF-8",
                                "type": "GET",
                                "url": sSource,
                                "data": aoData,
                                "success": function (msg) {
                                    //var j = $.parseJSON(msg.data);
                                    //var json = jQuery.parseJSON(msg);
                                    fnCallback(msg);
                                    $("#resultsTable").show();
                                },
                                error: function (xhr, textStatus, error) {
                                    if (typeof console == "object") {
                                        console.log(xhr.status + "," + xhr.responseText + "," + textStatus + "," + error);
                                    }
                                }
                            });
                        }
                    });
                    
                }
            );


            //$('#resultsTable').DataTable( {
            //    //data: dataSet,                
            //    columns: columns
            //} );
        });

    </script>    
</head>
<body>
    
<div class="row">

    <div class="col-sm-3 col-md-2 sidebar">
        <button id="btnQuery" padding="0 0 0 10" type="submit">Query</button>
        <div>
            <form id="queryForm">
                @{
                    foreach (var result in metadata)
                    {                        
                    @:<label for="@result.Dimension.Name">@result.Dimension.Name</label>
                    @:<p>
                    @:<input type="text" id="@result.Dimension.Name" name="@result.Dimension.Name" onfocus="javascript:$(this).autocomplete('search', '');" />
                    @:<div id="selectList">
                    @:    <ul></ul>
                    @:</div>
                    }
                }
            </form>
        </div>

    </div>

    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">        
        <table id="resultsTable" class="display" cellspacing="0" width="100%"></table>
    </div>

</div>

</body>
</html>
